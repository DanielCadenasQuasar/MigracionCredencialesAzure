<!-- Chosen Palette: Armonía Minimalista (Cobalto, Nieve y Pizarra) -->
<!-- Application Structure Plan: Dashboard colaborativo diseñado para ser publicado como web independiente.
     1. Capa de Autenticación Híbrida: Capaz de detectar si corre en el entorno local, en el chat o en una web propia mediante configuración dinámica.
     2. Vista de Planificación: Cronograma cronológico compacto con desplazamiento horizontal para control de ventanas de producción.
     3. Gestión Técnica: Grid de ejecución para los pilares de Azure Identity.
     Estructura optimizada para la persistencia multiusuario en despliegues reales. -->
<!-- Visualization & Content Choices: 
     - Consolidado de Validación -> Doughnut Chart (Chart.js) -> Meta del proyecto.
     - Carga por Cliente -> Stacked Horizontal Bar Chart (Chart.js) -> Gestión de recursos.
     - Timeline Temporal -> Vista de columnas cronológicas -> Planificación de subidas L/M.
     - NO SVG / NO Mermaid JS. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identity Hub: Dashboard de Migración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; scroll-behavior: smooth; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; height: 300px; max-height: 350px; }
        .timeline-track { display: flex; overflow-x: auto; gap: 1.25rem; padding: 1rem 0.5rem; scroll-snap-type: x proximity; }
        .timeline-track::-webkit-scrollbar { height: 4px; }
        .timeline-track::-webkit-scrollbar-track { background: #F1F5F9; }
        .timeline-track::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.04); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-shadow:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -4px rgba(59, 130, 246, 0.12); }
        .timeline-column { min-width: 260px; max-width: 260px; scroll-snap-align: start; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig = null;
        let appId = 'private-migration-app';
        let initialToken = null;

        // Intentar obtener configuración de Firebase (del entorno o de localStorage)
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') appId = __app_id;
                if (typeof __initial_auth_token !== 'undefined') initialToken = __initial_auth_token;
            } else {
                const savedConfig = localStorage.getItem('custom_firebase_config');
                if (savedConfig) firebaseConfig = JSON.parse(savedConfig);
            }
        } catch (e) { console.warn("Error cargando configuración Firebase."); }

        window.isLocalMode = !firebaseConfig;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.firestoreTools = { doc, setDoc, onSnapshot, collection, updateDoc };

            onAuthStateChanged(auth, (user) => {
                if (user) window.dispatchEvent(new CustomEvent('app-ready'));
            });

            const initAuth = async () => {
                try {
                    if (initialToken) await signInWithCustomToken(auth, initialToken);
                    else await signInAnonymously(auth);
                } catch (err) { window.isLocalMode = true; window.dispatchEvent(new CustomEvent('app-ready')); }
            };
            initAuth();
        } else {
            window.addEventListener('load', () => window.dispatchEvent(new CustomEvent('app-ready')));
        }
    </script>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-50 border-b border-slate-200 glass-nav">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 w-11 h-11 rounded-2xl flex items-center justify-center text-white font-black text-2xl shadow-lg shadow-blue-100">❖</div>
                <div>
                    <h1 class="text-lg font-extrabold tracking-tight">Identity Hub</h1>
                    <div id="sync-status" class="flex items-center gap-1.5 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        <span id="sync-dot" class="w-2 h-2 bg-slate-300 rounded-full"></span> 
                        <span id="sync-text">Cargando...</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="openConfigModal()" class="p-2.5 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors text-slate-500" title="Configurar Nube">
                    <span class="text-xs font-bold uppercase tracking-tighter">Configurar Nube</span>
                </button>
                <div class="hidden md:block text-right border-l border-slate-100 pl-6">
                    <p class="text-3xl font-black text-slate-900 leading-none" id="global-perc-display">0%</p>
                </div>
                <div class="w-14 h-14">
                    <canvas id="headerRadialProgress"></canvas>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-12">
        
        <!-- Sección 1: Análisis -->
        <section id="analytics" class="mb-20">
            <div class="max-w-3xl mb-12">
                <h2 class="text-3xl font-black text-slate-900 mb-4 tracking-tight">Estado de la Migración</h2>
                <p class="text-slate-600 leading-relaxed font-medium">Visualización de métricas críticas y tasa de éxito en la implementación de Azure Identity.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="bg-white p-10 rounded-[3rem] card-shadow border border-slate-100">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-10">Meta Global</h3>
                    <div class="chart-container"><canvas id="statusDoughnut"></canvas></div>
                </div>
                <div class="bg-white p-10 rounded-[3rem] card-shadow border border-slate-100">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-10">Progreso por Cliente</h3>
                    <div class="chart-container"><canvas id="clientBarChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- Sección 2: Planificación -->
        <section id="timeline-view" class="mb-20">
            <h2 class="text-3xl font-black text-slate-900 mb-8 tracking-tight">Planificación Temporal</h2>
            <div class="bg-slate-100/50 rounded-[3rem] p-6 border border-slate-200/60">
                <div id="timeline-container" class="timeline-track no-scrollbar"></div>
            </div>
        </section>

        <!-- Sección 3: Ejecución -->
        <section id="planning" class="mb-10">
            <h2 class="text-3xl font-black text-slate-900 mb-8 tracking-tight">Detalle de Ejecución</h2>
            <nav class="sticky top-24 z-40 overflow-x-auto no-scrollbar py-6 -mx-6 px-6 bg-slate-50/80 backdrop-blur-sm">
                <div class="flex gap-3" id="filter-bar"></div>
            </nav>
            <div id="grid-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 mt-10">
                <div id="loader" class="col-span-full py-40 flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-6 text-[11px] font-black text-slate-400 uppercase tracking-widest">Iniciando aplicación...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Edición -->
    <div id="edit-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white w-full max-w-lg rounded-[3.5rem] p-12 shadow-2xl relative transform transition-all duration-300 scale-95 opacity-0" id="modal-box">
            <h3 class="text-2xl font-black text-slate-900 mb-10">Editar Tarea</h3>
            <form id="editor-form" class="space-y-8">
                <input type="hidden" id="task-id">
                <div class="space-y-3">
                    <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Fecha Programada</label>
                    <input type="date" id="task-date" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm font-bold outline-none focus:ring-4 focus:ring-blue-100">
                </div>
                <div class="space-y-3">
                    <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">Responsable</label>
                    <input type="text" id="task-resp" class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm font-bold outline-none focus:ring-4 focus:ring-blue-100">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeEditor()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-5 rounded-2xl hover:bg-slate-200">Cancelar</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl shadow-blue-200">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Configuración Nube -->
    <div id="config-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-md">
        <div class="bg-white w-full max-w-xl rounded-[3rem] p-12 shadow-2xl">
            <h3 class="text-2xl font-black text-slate-900 mb-4 tracking-tight">Configurar Sincronización</h3>
            <p class="text-slate-500 text-sm mb-8">Pega aquí el objeto <code>firebaseConfig</code> de tu proyecto de Firebase para habilitar la web privada sincronizada.</p>
            <textarea id="firebase-json" class="w-full h-48 bg-slate-50 border border-slate-100 rounded-2xl p-6 font-mono text-xs outline-none mb-8 focus:ring-4 focus:ring-blue-100" placeholder='{ "apiKey": "...", "projectId": "...", ... }'></textarea>
            <div class="flex gap-4">
                <button onclick="closeConfigModal()" class="flex-1 bg-slate-100 text-slate-500 font-bold py-5 rounded-2xl">Cancelar</button>
                <button onclick="saveConfig()" class="flex-1 bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl shadow-blue-100">Habilitar Nube</button>
            </div>
        </div>
    </div>

    <script type="module">
        const SOURCE_REPORT = [
            { id: 1725, app: "PSP Landing", client: "MEDIA MARKT", date: "Lunes 9 de Febrero", responsible: "Carlos Ruiz" },
            { id: 1726, app: "Customer Portal", client: "MEDIA MARKT", date: "Martes 10 de Febrero", responsible: "Ana García" },
            { id: 1727, app: "Documanager API", client: "MEDIA MARKT", date: "Lunes 16 de Febrero", responsible: "Elena Sanz" },
            { id: 1728, app: "Documanager Portal", client: "MEDIA MARKT", date: "Lunes 16 de Febrero", responsible: "Elena Sanz" },
            { id: 1729, app: "PSP Api", client: "MEDIA MARKT", date: "Martes 17 de Febrero", responsible: "Carlos Ruiz" },
            { id: 1730, app: "PSP Portal", client: "MEDIA MARKT", date: "Martes 17 de Febrero", responsible: "Carlos Ruiz" },
            { id: 1731, app: "Paycontroller API", client: "MEDIA MARKT", date: "Lunes 23 de Febrero", responsible: "Marcos López" },
            { id: 1732, app: "Paycontroller Portal", client: "MEDIA MARKT", date: "Martes 24 de Febrero", responsible: "Marcos López" },
            { id: 1733, app: "Documanager API", client: "SQT", date: "Lunes 9 de Marzo", responsible: "Ana García" },
            { id: 1734, app: "Documanager Portal", client: "SQT", date: "Lunes 9 de Marzo", responsible: "Ana García" },
            { id: 1735, app: "PSP Api", client: "SQT", date: "Martes 10 de Marzo", responsible: "Elena Sanz" },
            { id: 1736, app: "PSP Portal", client: "SQT", date: "Martes 10 de Marzo", responsible: "Elena Sanz" },
            { id: 1737, app: "Paycontroller API", client: "SQT", date: "Lunes 16 de Marzo", responsible: "Carlos Ruiz" },
            { id: 1738, app: "Paycontroller Portal", client: "SQT", date: "Martes 17 de Marzo", responsible: "Carlos Ruiz" },
            { id: 1739, app: "Documanager API", client: "D&G SPAIN", date: "Lunes 23 de Marzo", responsible: "Marcos López" },
            { id: 1740, app: "Documanager Portal", client: "D&G SPAIN", date: "Lunes 23 de Marzo", responsible: "Marcos López" },
            { id: 1741, app: "Paycontroller API", client: "D&G SPAIN", date: "Martes 24 de Marzo", responsible: "Elena Sanz" },
            { id: 1742, app: "Paycontroller API", client: "D&G USA", date: "Lunes 30 de Marzo", responsible: "Ana García" },
            { id: 1743, app: "Paycontroller API", client: "D&G UK", date: "Martes 31 de Marzo", responsible: "Ana García" },
            { id: 1747, app: "PSP Api", client: "ZURICH", date: "Lunes 6 de Abril", responsible: "Carlos Ruiz" },
            { id: 1724, app: "PSP Portal", client: "ZURICH", date: "Martes 7 de Abril", responsible: "Carlos Ruiz" }
        ];

        let state = { tasks: [], filter: "TODOS", charts: { doughnut: null, bar: null, header: null } };
        const LS_TASKS = 'migration_tasks_v6';

        const formatDateToSpanish = (isoDate) => {
            if (!isoDate) return "";
            const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const date = new Date(isoDate + 'T12:00:00');
            return `${days[date.getDay()]} ${date.getDate()} de ${months[date.getMonth()]}`;
        };

        const tryParseSpanishToISO = (str) => {
            try {
                const months = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
                const parts = str.toLowerCase().split(' ');
                let dIdx = -1, mIdx = -1;
                parts.forEach((p, i) => { if(!isNaN(p)) dIdx = i; if(months.includes(p)) mIdx = i; });
                if (dIdx === -1 || mIdx === -1) return "";
                const day = parts[dIdx].padStart(2, '0');
                const month = (months.indexOf(parts[mIdx]) + 1).toString().padStart(2, '0');
                return `2026-${month}-${day}`;
            } catch (e) { return ""; }
        };

        const getTimestamp = (str) => { const iso = tryParseSpanishToISO(str); return iso ? new Date(iso).getTime() : 0; };

        const setupApp = () => {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');

            if (window.isLocalMode) {
                dot.className = "w-2 h-2 bg-amber-500 rounded-full";
                txt.innerText = "Modo Local Persistente";
                const saved = localStorage.getItem(LS_TASKS);
                state.tasks = saved ? JSON.parse(saved) : SOURCE_REPORT.map(t => ({ ...t, status: 'pending', components: { sql: false, storage: false, redis: false, keyvault: false } }));
                renderAll();
            } else {
                const { onSnapshot, collection, doc, setDoc } = window.firestoreTools;
                const ref = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'migrationTasks');
                onSnapshot(ref, (snap) => {
                    if (snap.empty) {
                        const init = SOURCE_REPORT.map(t => ({ ...t, status: 'pending', components: { sql: false, storage: false, redis: false, keyvault: false } }));
                        init.forEach(i => setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'migrationTasks', i.id.toString()), i));
                        state.tasks = init;
                    } else {
                        state.tasks = snap.docs.map(d => d.data()).sort((a,b) => a.id - b.id);
                    }
                    dot.className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
                    txt.innerText = "Sincronizado Nube";
                    renderAll();
                });
            }
        };

        const renderAll = () => {
            document.getElementById('loader')?.remove();
            renderFilters();
            renderTimeline();
            renderGrid();
            renderCharts();
        };

        const renderFilters = () => {
            const container = document.getElementById('filter-bar');
            const clients = ["TODOS", ...new Set(SOURCE_REPORT.map(t => t.client))];
            container.innerHTML = clients.map(c => `<button onclick="setFilter('${c}')" class="px-8 py-3 rounded-2xl text-[11px] font-black transition-all border-2 ${state.filter === c ? 'bg-slate-900 border-slate-900 text-white shadow-xl' : 'bg-white border-slate-100 text-slate-400'}">${c}</button>`).join('');
        };

        const renderTimeline = () => {
            const container = document.getElementById('timeline-container');
            const datesMap = {};
            state.tasks.forEach(t => { if (!datesMap[t.date]) datesMap[t.date] = []; datesMap[t.date].push(t); });
            const sorted = Object.keys(datesMap).sort((a,b) => getTimestamp(a) - getTimestamp(b));
            container.innerHTML = sorted.map(date => {
                const grp = datesMap[date];
                const perc = Math.round((grp.filter(t => t.status === 'done').length / grp.length) * 100);
                return `<div class="timeline-column flex flex-col gap-3">
                    <div class="bg-white p-4 rounded-[1.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                        <div class="text-[9px] font-black text-blue-600 uppercase tracking-widest mb-0.5">${date.split(' ')[0]}</div>
                        <div class="text-[12px] font-black text-slate-800 mb-2">${date.split(' ').slice(1).join(' ')}</div>
                        <div class="w-full bg-slate-50 h-1 rounded-full overflow-hidden"><div class="bg-blue-600 h-full transition-all duration-500" style="width: ${perc}%"></div></div>
                    </div>
                    <div class="flex flex-col gap-2">${grp.map(t => `<div onclick="openEditor(${t.id})" class="cursor-pointer group bg-white/60 p-2.5 rounded-xl border border-white hover:border-blue-100 card-shadow transition-all">
                        <div class="flex justify-between items-center mb-1"><span class="text-[8px] font-black text-slate-400 uppercase truncate pr-2">${t.client}</span><div class="w-1.5 h-1.5 rounded-full ${t.status === 'done' ? 'bg-green-500' : 'bg-slate-200'}"></div></div>
                        <div class="text-[10px] font-bold text-slate-700 truncate group-hover:text-blue-600">${t.app}</div>
                    </div>`).join('')}</div>
                </div>`;
            }).join('');
        };

        const renderGrid = () => {
            const grid = document.getElementById('grid-container');
            const items = state.filter === "TODOS" ? state.tasks : state.tasks.filter(t => t.client === state.filter);
            grid.innerHTML = items.map(t => `<div class="bg-white rounded-[3.5rem] p-10 card-shadow border border-slate-50 relative group">
                <div class="flex justify-between items-start mb-8"><span class="text-[10px] font-black text-slate-200">ID ${t.id}</span><button onclick="openEditor(${t.id})" class="p-2.5 rounded-full bg-slate-50 text-slate-300 hover:text-blue-600 opacity-0 group-hover:opacity-100 font-bold text-[10px] uppercase transition-all tracking-wider">Ajustar</button></div>
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl text-[10px] font-black uppercase mb-8 border-2 ${t.date.includes('Lunes') || t.date.includes('Martes') ? 'bg-indigo-50 border-indigo-100 text-indigo-700' : 'bg-amber-50 border-amber-100 text-amber-700'}">● ${t.date}</div>
                <h3 class="text-2xl font-black text-slate-900 mb-2 leading-tight">${t.app}</h3>
                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-10">${t.client}</p>
                <div class="flex items-center gap-4 bg-slate-50/50 p-4 rounded-2xl mb-12 border border-slate-50">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-black text-xs">${t.responsible.split(' ').map(n => n[0]).join('')}</div>
                    <div><p class="text-[9px] font-black text-slate-300 uppercase leading-none mb-1">Encargado</p><span class="text-sm font-extrabold text-slate-700">${t.responsible}</span></div>
                </div>
                <div class="space-y-4 mb-10">${renderCheck(t.id, 'sql', 'SQL Identity', t.components.sql)}${renderCheck(t.id, 'storage', 'Azure Storage', t.components.storage)}${renderCheck(t.id, 'redis', 'Redis Cache', t.components.redis)}${renderCheck(t.id, 'keyvault', 'Key Vault Sync', t.components.keyvault)}</div>
                <div class="pt-8 border-t border-slate-50 flex items-center gap-3"><div class="w-3.5 h-3.5 rounded-full ${t.status === 'done' ? 'bg-green-500 animate-pulse' : 'bg-slate-200'}"></div><span class="text-[11px] font-black uppercase tracking-[0.1em] ${t.status === 'done' ? 'text-green-600' : 'text-slate-400'}">${t.status === 'done' ? 'Protocolo Completado' : 'Validación Pendiente'}</span></div>
            </div>`).join('');
        };

        const renderCheck = (id, k, l, a) => `<button onclick="toggleCheck(${id},'${k}')" class="w-full flex items-center justify-between px-6 py-4.5 rounded-2xl border-2 transition-all ${a ? 'bg-blue-50 border-blue-100 text-blue-700' : 'bg-white border-slate-50 text-slate-300'}"><span class="text-[12px] font-black tracking-tight">${l}</span><span class="text-2xl font-black">${a ? '●' : '○'}</span></button>`;

        const renderCharts = () => {
            const done = state.tasks.filter(t => t.status === 'done').length;
            const perc = Math.round((done / state.tasks.length) * 100);
            document.getElementById('global-perc-display').innerText = `${perc}%`;
            const ctx1 = document.getElementById('statusDoughnut').getContext('2d');
            const ctx2 = document.getElementById('clientBarChart').getContext('2d');
            const ctx3 = document.getElementById('headerRadialProgress').getContext('2d');
            if (state.charts.doughnut) state.charts.doughnut.destroy();
            if (state.charts.bar) state.charts.bar.destroy();
            if (state.charts.header) state.charts.header.destroy();
            state.charts.doughnut = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Hecho', 'Pdte'], datasets: [{ data: [done, state.tasks.length - done], backgroundColor: ['#2563eb', '#F1F5F9'], borderWidth: 0, cutout: '85%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            const clients = [...new Set(state.tasks.map(t => t.client))];
            state.charts.bar = new Chart(ctx2, { type: 'bar', data: { labels: clients, datasets: [{ label: 'Hecho', data: clients.map(c => state.tasks.filter(t => t.client === c && t.status === 'done').length), backgroundColor: '#2563eb', borderRadius: 14 }, { label: 'Total', data: clients.map(c => state.tasks.filter(t => t.client === c && t.status !== 'done').length), backgroundColor: '#F1F5F9', borderRadius: 14 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, display: false }, y: { stacked: true, border: { display: false }, grid: { display: false }, ticks: { font: { weight: '800', size: 10 } } } }, plugins: { legend: { display: false } } } });
            state.charts.header = new Chart(ctx3, { type: 'doughnut', data: { datasets: [{ data: [perc, 100 - perc], backgroundColor: ['#2563eb', '#F1F5F9'], borderWidth: 0 }] }, options: { cutout: '78%', plugins: { tooltip: { enabled: false } } } });
        };

        window.setFilter = (f) => { state.filter = f; renderAll(); };
        window.toggleCheck = async (id, k) => {
            const task = state.tasks.find(t => t.id === id);
            task.components[k] = !task.components[k];
            task.status = Object.values(task.components).every(v => v) ? 'done' : 'pending';
            if (window.isLocalMode) { localStorage.setItem(LS_TASKS, JSON.stringify(state.tasks)); renderAll(); }
            else { await window.firestoreTools.updateDoc(window.firestoreTools.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'migrationTasks', id.toString()), { components: task.components, status: task.status }); }
        };
        window.openEditor = (id) => {
            const t = state.tasks.find(x => x.id === id);
            document.getElementById('task-id').value = id;
            document.getElementById('task-date').value = tryParseSpanishToISO(t.date);
            document.getElementById('task-resp').value = t.responsible;
            document.getElementById('edit-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-box').classList.remove('scale-95', 'opacity-0'), 10);
        };
        window.closeEditor = () => { document.getElementById('modal-box').classList.add('scale-95', 'opacity-0'); setTimeout(() => document.getElementById('edit-modal').classList.add('hidden'), 300); };
        document.getElementById('editor-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('task-id').value;
            const task = state.tasks.find(x => x.id == id);
            const date = formatDateToSpanish(document.getElementById('task-date').value) || task.date;
            const resp = document.getElementById('task-resp').value;
            if (window.isLocalMode) { task.date = date; task.responsible = resp; localStorage.setItem(LS_TASKS, JSON.stringify(state.tasks)); renderAll(); }
            else { await window.firestoreTools.updateDoc(window.firestoreTools.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'migrationTasks', id), { date, responsible: resp }); }
            closeEditor();
        };

        window.openConfigModal = () => document.getElementById('config-modal').classList.remove('hidden');
        window.closeConfigModal = () => document.getElementById('config-modal').classList.add('hidden');
        window.saveConfig = () => {
            const json = document.getElementById('firebase-json').value;
            if (json) {
                localStorage.setItem('custom_firebase_config', json);
                alert("Configuración guardada. La página se recargará.");
                location.reload();
            }
        };

        window.addEventListener('app-ready', setupApp);
    </script>
</body>
</html>